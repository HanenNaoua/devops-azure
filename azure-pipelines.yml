trigger:
- main

pool:
  name: default

stages:

# üî® STAGE 1: BUILD + TEST + PUSH IMAGE
- stage: Build
  displayName: "Build and Test Stage"
  jobs:
  - job: BuildJob
    displayName: "Build Angular App, Test, Dockerize"
    steps:

    # Checkout code
    - checkout: self
      clean: true

    # V√©rifier package.json
    - script: |
        if [ ! -f "$(Build.SourcesDirectory)/angular-app-kubernetes/package.json" ]; then
          echo "‚ùå Erreur: package.json introuvable !"
          exit 1
        fi
      displayName: "V√©rifier l'existence de package.json"
      
    # Node.js
    - task: UseNode@1
      inputs:
        version: '20.x'
      displayName: 'Use Node.js 20'

    # Installer CLI, puppeteer et d√©pendances
    - script: |
        cd angular-app-kubernetes
        npm install -g @angular/cli@16
        npm install --legacy-peer-deps
        npm install puppeteer karma-junit-reporter --save-dev
      displayName: "Installer d√©pendances + Puppeteer"

    # Build Angular
    - script: |
        cd angular-app-kubernetes
        export NODE_OPTIONS=--openssl-legacy-provider
        npm run build -- --configuration=production
      displayName: 'Build Angular Project'