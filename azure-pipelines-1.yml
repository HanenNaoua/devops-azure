trigger:
- main

pool:
  name: default  # VÃ©rifie que ce pool contient un agent compatible avec Java, Docker et SonarCloud

steps:

# 1ï¸âƒ£ Checkout du code
- checkout: self
  clean: true
  persistCredentials: true

# 2ï¸âƒ£ VÃ©rifier l'existence de package.json
- script: |
    if [ ! -f "$(Build.SourcesDirectory)/angular-app-kubernetes/package.json" ]; then
      echo "âŒ Erreur: package.json introuvable !"
      exit 1
    fi
  displayName: "VÃ©rifier l'existence de package.json"

# 3ï¸âƒ£ Installer Node.js 20
- task: UseNode@1
  inputs:
    version: '20.x'
  displayName: 'Use Node.js 20'

# 4ï¸âƒ£ Installer Angular CLI et les dÃ©pendances
- script: |
    echo "ğŸ“¦ Installation de Angular CLI et des dÃ©pendances"
    cd $(Build.SourcesDirectory)/angular-app-kubernetes
    npm install -g @angular/cli@16
    npm install
    ng version
  displayName: 'Install Angular CLI and dependencies'

# 5ï¸âƒ£ ğŸ” **PrÃ©parer l'analyse SonarCloud**

# 5ï¸âƒ£ ğŸš€ Build du projet Angular
- script: |
    echo "ğŸš€ Build du projet Angular"
    cd $(Build.SourcesDirectory)/angular-app-kubernetes
    npm run build -- --configuration=production
  displayName: 'Build Angular Project'

# 5ï¸âƒ£ ğŸ” ExÃ©cuter l'analyse SonarCloud

# 6ï¸âƒ£ ğŸ“¢ Publier le rapport SonarCloud


# 6ï¸âƒ£ ğŸ” Connexion Ã  Docker Hub
- task: Docker@2
  inputs:
    command: 'login'
    containerRegistry: 'DockerHub-Connection'  # VÃ©rifie que ce nom est exactement celui configurÃ© dans Azure DevOps
  displayName: 'Login to Docker Hub'

# 6ï¸âƒ£ ğŸ³ Build & Push Docker Image to Docker Hub
- task: Docker@2
  inputs:
    command: 'buildAndPush'
    containerRegistry: 'DockerHub'  # le mÃªme que juste avant
    repository: 'hanen90/devops-azure'  # DockerHub username/repository
    tags: 'latest'
    Dockerfile: 'angular-app-kubernetes/Dockerfile'
  displayName: 'Build and Push Docker Image to Docker Hub'

# 7ï¸âƒ£ VÃ©rification du contenu du dossier dist pour publication
- script: |
    echo "ğŸ“‚VÃ©rification du contenu du dossier dist aprÃ¨s build"
    ls -l dist/angular-app # VÃ©rifier le contenu du dossier angular-app aprÃ¨s build
  displayName: 'Verify dist folder content'


# 7ï¸âƒ£ ğŸ“‚ VÃ©rification du contenu du dossier dist
#- script: |
 #   echo "ğŸ“‚ VÃ©rification du dossier dist"
  #  ls -l $(Build.SourcesDirectory)/angular-app-kubernetes/dist/angular-app
  #displayName: 'Verify dist folder content'

# 8ï¸âƒ£ ğŸ“¦ Publier l'artefact de build
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/angular-app-kubernetes/dist/angular-app'
    artifactName: 'angular-app-artifact'
    publishLocation: 'Container'
  displayName: 'Publish Build Artifact'