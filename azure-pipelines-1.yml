trigger:
- main

pool:
  name: default  # VÃ©rifie que ce pool contient un agent compatible avec Java, Docker et SonarCloud

steps:

# 1ï¸âƒ£ Checkout du code
- checkout: self
  clean: true
  persistCredentials: true

# 2ï¸âƒ£ VÃ©rifier l'existence de package.json
- script: |
    if [ ! -f "$(Build.SourcesDirectory)/angular-app-kubernetes/package.json" ]; then
      echo "âŒ Erreur: package.json introuvable !"
      exit 1
    fi
  displayName: "VÃ©rifier l'existence de package.json"

# 3ï¸âƒ£ Installer Node.js 20
- task: UseNode@1
  inputs:
    version: '20.x'
  displayName: 'Use Node.js 20'

# 4ï¸âƒ£ Installer Angular CLI et les dÃ©pendances
- script: |
    echo "ğŸ“¦ Installation de Angular CLI et des dÃ©pendances"
    cd $(Build.SourcesDirectory)/angular-app-kubernetes
    npm install -g @angular/cli@16
    npm install --legacy-peer-deps
    ng version
  displayName: 'Install Angular CLI and dependencies'

# 5ï¸âƒ£ ğŸ” **PrÃ©parer l'analyse SonarCloud**

# 6ï¸âƒ£ ğŸš€ Build du projet Angular
- script: |
    echo "ğŸš€ Build du projet Angular"
    cd $(Build.SourcesDirectory)/angular-app-kubernetes
    export NODE_OPTIONS=--openssl-legacy-provider
    npm run build -- --configuration=production
  displayName: 'Build Angular Project'

  # ğŸ“Œ Ã‰tape 10 : ExÃ©cuter les tests unitaires
- script: |
    echo "ğŸ§ª ExÃ©cution des tests"
    cd $(Build.SourcesDirectory)/angular-app-kubernetes
    npm install --legacy-peer-deps
    npm run test
  displayName: 'ExÃ©cuter les tests unitaires'
  workingDirectory: $(System.DefaultWorkingDirectory)

  # ğŸ“Œ Ã‰tape 11 : Publier les rÃ©sultats des tests
- task: PublishTestResults@2
  inputs:
    testResultsFiles: 'srctest-results/TEST-results.xml'  # â† ajuste ce chemin si besoin
    testRunTitle: 'RÃ©sultats des tests du frontend'
    mergeTestResults: true
    failTaskOnFailedTests: true
  condition: always()
  displayName: 'Publier les rÃ©sultats des tests'

# 7ï¸âƒ£** VÃ©rifier que le dossier dist/ a bien Ã©tÃ© gÃ©nÃ©rÃ©**
- script: |
    echo " VÃ©rification du dossier dist aprÃ¨s build"
    ls -l $(Build.SourcesDirectory)/angular-app-kubernetes/dist/angular-app || (echo " 
    Dossier dist/angular-app non trouvÃ© !" && exit 1)
  displayName: "Verify Angular Build Output"
# 8ï¸âƒ£** Publier l'artefact du build Angular**
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/angular-app-kubernetes/dist/angular-app'
    artifactName: 'angular-app-artifact'
    publishLocation: 'Container'
  displayName: 'Publish Build Artifact'

# 5ï¸âƒ£ ğŸ” ExÃ©cuter l'analyse SonarCloud

# 6ï¸âƒ£ ğŸ“¢ Publier le rapport SonarCloud


# 6ï¸âƒ£ ğŸ” Connexion Ã  Docker Hub
- task: Docker@2
  inputs:
    command: 'login'
    containerRegistry: 'DockerHub-Connection'  # VÃ©rifie que ce nom est exactement celui configurÃ© dans Azure DevOps
  displayName: 'Login to Docker Hub'

# 6ï¸âƒ£ ğŸ³ Build & Push Docker Image to Docker Hub
- task: Docker@2
  inputs:
    command: 'buildAndPush'
    containerRegistry: 'DockerHub'  # le mÃªme que juste avant
    repository: 'hanen90/devops-azure'  # DockerHub username/repository
    tags: 'latest'
    Dockerfile: 'angular-app-kubernetes/Dockerfile'
  displayName: 'Build and Push Docker Image to Docker Hub'

# 1âƒ£4âƒ£**ğŸ›  VÃ©rification que lâ€™image Docker a bien Ã©tÃ© crÃ©Ã©e**
- script: |
    echo " VÃ©rification des images Docker disponibles"
    docker images | grep "hanen90/devops-azure" || (echo " Image non trouvÃ©e, vÃ©rifiez Docker Hub !" && exit 1)
  displayName: "Verify Docker Image"
